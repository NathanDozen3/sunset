<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sunrise and Sunset Times</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full">
    <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">Sunrise and Sunset Times</h1>
    <div class="flex flex-col gap-4">
      <div class="relative">
        <input type="text" id="searchInput" placeholder="Enter city or address" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <div id="autocomplete-list" class="absolute w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-48 overflow-y-auto z-10 hidden"></div>
      </div>
      <input type="date" id="dateInput" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <div class="flex gap-2">
        <button onclick="searchLocationSunTimes()" class="flex-1 bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600">Search</button>
        <button onclick="resetToUserLocation()" class="flex-1 bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600">Reset</button>
      </div>
    </div>
    <div class="mt-4 text-gray-700">
      <p id="location">Fetching location...</p>
      <p id="timezone">Timezone: --</p>
      <p id="date">Date: --</p>
      <p id="sunrise">Sunrise: --</p>
      <p id="sunset">Sunset: --</p>
    </div>
  </div>
  <div id="map" class="w-full max-w-lg h-96 mt-4 rounded-lg shadow-lg"></div>
  <footer class="mt-4 text-sm text-gray-600 text-center">
    <p>Data provided by <a href="https://www.openstreetmap.org/copyright" target="_blank" class="underline">OpenStreetMap</a> and <a href="https://nominatim.openstreetmap.org" target="_blank" class="underline">Nominatim</a>.</p>
  </footer>

  <script>
    const TIMEZONEDB_API_KEY = 'YOUR_API_KEY';

    let map, marker;

    function initMap(lat, lon, locationName) {
      if (map) {
        map.remove();
      }
      map = L.map('map').setView([lat, lon], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      marker = L.marker([lat, lon]).addTo(map)
        .bindPopup(locationName)
        .openPopup();
    }

    function getSunriseSunset(lat, lon, date, timezoneOffset) {
      const calcDate = date ? new Date(date) : new Date();
      const times = SunCalc.getTimes(calcDate, lat, lon);
      const offsetMs = timezoneOffset * 1000;
      const sunrise = new Date(times.sunrise.getTime() + offsetMs).toLocaleTimeString([], { timeZone: 'UTC' });
      const sunset = new Date(times.sunset.getTime() + offsetMs).toLocaleTimeString([], { timeZone: 'UTC' });
      const formattedDate = calcDate.toLocaleDateString();
      return { sunrise, sunset, formattedDate };
    }

    async function getLocationName(lat, lon) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`);
        const data = await response.json();
        return data.display_name || 'Unknown location';
      } catch (error) {
        console.error('Location lookup error:', error);
        return 'Location lookup failed';
      }
    }

    async function getTimezone(lat, lon) {
      if (TIMEZONEDB_API_KEY === 'YOUR_API_KEY') {
        throw new Error('TimeZoneDB API key missing. Please configure the TIMEZONEDB_API_KEY.');
      }
      try {
        const response = await fetch(`https://api.timezonedb.com/v2.1/get-time-zone?key=${TIMEZONEDB_API_KEY}&format=json&by=position&lat=${lat}&lng=${lon}`);
        const data = await response.json();
        if (data.status !== 'OK') throw new Error('Timezone lookup failed');
        return { zoneName: data.zoneName, offset: data.gmtOffset };
      } catch (error) {
        console.error('Timezone lookup error:', error);
        return { zoneName: 'Unknown', offset: 0 };
      }
    }

    async function fetchSuggestions(query) {
      if (!query) return [];
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
        const data = await response.json();
        return data.map(item => item.display_name);
      } catch (error) {
        console.error('Autocomplete error:', error);
        return [];
      }
    }

    function setupAutocomplete() {
      const input = document.getElementById('searchInput');
      const autocompleteList = document.getElementById('autocomplete-list');
      let timeoutId;

      input.addEventListener('input', async () => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(async () => {
          const query = input.value.trim();
          const suggestions = await fetchSuggestions(query);
          autocompleteList.innerHTML = '';
          autocompleteList.classList.toggle('hidden', suggestions.length === 0);
          if (suggestions.length > 0) {
            suggestions.forEach(suggestion => {
              const div = document.createElement('div');
              div.textContent = suggestion;
              div.className = 'p-2 cursor-pointer hover:bg-gray-100';
              div.addEventListener('click', () => {
                input.value = suggestion;
                autocompleteList.innerHTML = '';
                autocompleteList.classList.add('hidden');
                searchLocationSunTimes();
              });
              autocompleteList.appendChild(div);
            });
          }
        }, 300);
      });

      document.addEventListener('click', e => {
        if (!input.contains(e.target) && !autocompleteList.contains(e.target)) {
          autocompleteList.innerHTML = '';
          autocompleteList.classList.add('hidden');
        }
      });
    }

    async function searchLocationSunTimes() {
      const query = document.getElementById('searchInput').value.trim();
      const date = document.getElementById('dateInput').value;
      if (!query) {
        document.getElementById('location').textContent = 'Please enter a location';
        return;
      }

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await response.json();
        if (data.length === 0) {
          document.getElementById('location').textContent = 'Location not found';
          return;
        }

        const { lat, lon, display_name } = data[0];
        const { zoneName, offset } = await getTimezone(lat, lon);
        const { sunrise, sunset, formattedDate } = getSunriseSunset(lat, lon, date, offset);
        document.getElementById('location').textContent = `Location: ${display_name} (Lat ${parseFloat(lat).toFixed(2)}, Lon ${parseFloat(lon).toFixed(2)})`;
        document.getElementById('timezone').textContent = `Timezone: ${zoneName}`;
        document.getElementById('date').textContent = `Date: ${formattedDate}`;
        document.getElementById('sunrise').textContent = `Sunrise: ${sunrise}`;
        document.getElementById('sunset').textContent = `Sunset: ${sunset}`;
        initMap(parseFloat(lat), parseFloat(lon), display_name);
      } catch (error) {
        document.getElementById('location').textContent = error.message || 'Search failed';
        console.error('Search error:', error);
      }
    }

    async function getUserLocationSunTimes() {
      if (!navigator.geolocation) {
        document.getElementById('location').textContent = 'Geolocation not supported';
        return;
      }

      const date = document.getElementById('dateInput').value;
      navigator.geolocation.getCurrentPosition(
        async position => {
          const { latitude, longitude } = position.coords;
          const { zoneName, offset } = await getTimezone(latitude, longitude);
          const { sunrise, sunset, formattedDate } = getSunriseSunset(latitude, longitude, date, offset);
          const locationName = await getLocationName(latitude, longitude);
          document.getElementById('location').textContent = `Location: ${locationName} (Lat ${latitude.toFixed(2)}, Lon ${longitude.toFixed(2)})`;
          document.getElementById('timezone').textContent = `Timezone: ${zoneName}`;
          document.getElementById('date').textContent = `Date: ${formattedDate}`;
          document.getElementById('sunrise').textContent = `Sunrise: ${sunrise}`;
          document.getElementById('sunset').textContent = `Sunset: ${sunset}`;
          initMap(latitude, longitude, locationName);
        },
        error => {
          let errorMessage = 'Unable to fetch location';
          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = 'Location access denied';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = 'Location unavailable';
              break;
            case error.TIMEOUT:
              errorMessage = 'Location request timed out';
              break;
          }
          document.getElementById('location').textContent = errorMessage;
          console.error('Geolocation error:', error.message);
        },
        { timeout: 10000, maximumAge: 60000 }
      );
    }

    function resetToUserLocation() {
      document.getElementById('searchInput').value = '';
      document.getElementById('autocomplete-list').innerHTML = '';
      document.getElementById('dateInput').value = '';
      getUserLocationSunTimes();
    }

    window.onload = () => {
      if (TIMEZONEDB_API_KEY === 'YOUR_API_KEY') {
        document.getElementById('location').textContent = 'TimeZoneDB API key missing. Please configure the TIMEZONEDB_API_KEY.';
        return;
      }
      getUserLocationSunTimes();
      setupAutocomplete();
    };
  </script>
</body>
</html>